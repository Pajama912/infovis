# Team : SixTean

# TODO
- ✅ ~~OpenStreetMap APIの使用方法の調査~~
- 地図部分の実装方法の調査
    - 詳細な白地図についての検討（市町村以下のレベル）
- 地図の一部分に色をつける方法の調査
- Webページの構築
    - ✅ ~~レイアウト作成~~
    - ✅ ~~データ取得部分のアルゴリズム作成~~
    - ✅ ~~データ表示部分のアルゴリズム作成~~
- 項目分類の決定
- データのダウンロード
    - 教育関連
        - ✅ ~~大学~~
        - ✅ ~~短大・専門学校~~
        - ✅ ~~小学校・中学校・高校~~
        - ✅ ~~幼稚園~~
    - 公共施設
        - ✅ ~~公共トイレ~~
        - ✅ ~~ポスト~~
        - ✅ ~~警察署・交番~~
        - ✅ ~~病院~~
        - ✅ ~~図書館~~
        - ✅ ~~公園~~
        - ✅ ~~消防署~~
        - ✅ ~~郵便局~~
        - 街灯
    - 飲食店
        - ✅ ~~カフェ~~
        - ✅ ~~コンビニ~~
        - ✅ ~~スーパー~~
        - ✅ ~~ファミレス~~
        - ✅ ~~レストラン~~
    - 観光
        - ✅ ~~寺社仏閣~~
    - 地形
        - 坂
        - 川
    
- データの整形
    - 教育関連
        - 大学
        - 短大・専門学校
        - 小学校・中学校・高校
        - 幼稚園
    - 公共施設
        - 公共トイレ
        - ポスト
        - 警察署・交番
        - 病院
        - 図書館
        - 公園
        - 消防署
        - 郵便局
        - 街灯
    - 飲食店
        - カフェ
        - コンビニ
        - スーパー
    - 観光
        - 寺社仏閣
    - 地形
        - 坂
        - 川

# Pre Reviewの指摘内容
- 地価とかの情報があれば引っ越しのときに使いやすそう
    - 周りの施設の濃度だけで地域を選ぶと新宿などがヒットしてしまう)
- 標高の情報もあればいいかも
    - 標高と坂の個数の相関みたいなものが見る事ができたら面白い
- 密度を表示するだけではなく，ある特定の座標に対して実際にお店や地形などが何個あるのかを表示できたらいい
- 大きな区の中でも栄えているところと栄えていないところで違いが見えるように，分け方を工夫する
    - 区という分け方ではなく座標で全部管理する予定
    - ただ区の境目みたいなものは見たいよね

# scriptsの中のPythonコードの実行
```bash
% python3 -m venv venv
% source venv/bin/activate
% pip install -r requirement.txt
``` 

# OpenStreetMapAPI(Overpass API)の叩き方
複数のクエリ形式（命令の形式）があるがOverpass QLについて。  

## OSMの基本
OSM上での物の表し方はノード、ウェイ、リレーションの三つ
- ノード：特定の一点
- ウェイ：ノードを繋ぎ合わせたもの。始点終点が同じ場合はエリアと呼ばれる
- リレーション：ノード・ウェイを組み合わせたもの  

## APIの叩き方
[Wiki](https://wiki.openstreetmap.org/wiki/JA:Overpass_API/%E8%A8%80%E8%AA%9E%E3%82%AC%E3%82%A4%E3%83%89)  
[Wiki（正確な方）](https://wiki.openstreetmap.org/wiki/JA:Overpass_API/Overpass_QL)  
基本的な形式は
```
[out:json];
式1;
式2;
式3;
out;
```
式が順番に実行されて検索範囲が狭まる。  
式は
type（node, way, area, relation, derived, nwrなど）とその後に続くフィルタ（\[name=""],(低緯度, 低経度, 高緯度, 高経度)）で構成される。

### type一覧
よく使うのは以下の三つ
- node：ノード
- way：ウェイ
- area：エリア

### フィルタ一覧
こちらもよく使うもののみ
- \[タグ = ""]：タグがその後に指定された文字列と完全一致するデータ。複数使うとand検索
- (低緯度, 低経度, 高緯度, 高経度)：指定された範囲あるデータ
- (area)：現在のエリアにあるデータ

### タグ一覧
[こちら](https://wiki.openstreetmap.org/wiki/JA:Map_Features)を参照

### 使用例
#### 大学を取得
```
[out:json];
area[name="東京都"];
node(area.tokyo)[amenity="university"];
out;
```
#### 専門学校、小中高、大学を取得
```
[out:json];
area[name="東京都"]->.tokyo;
(
    node(area.tokyo)[amenity="college"][name];
    node(area.tokyo)[amenity="school"][name];
    node(area.tokyo)[amenity="university"][name];
);
out;
```
\[name]はnameタグが設定されているものを取ってくる。
()は和集合。

### 11/9追記(渡部)
- サンプルとして取得した大学のデータに高校が一つ混ざっていることを確認。海外のサイトでこう言うことは今後も起こりうるので，出力に対して大きなミスや誤訳みたなものがないかはざっくりとしたチェックが必要。

- l251~にも日本語が省略されているところがあり(上の項目の帝京大学が続いていると思われる)，ここはやはり手作業で治していく必要があると思われる。一旦放置。

- 大学のみに関して言うと，同じ座標に同じ大学の違う学部のデータがあったりする。大学以外にはこう言う施設はなさそうだからいいのかな

# topojson と geojson の使用
東京都の白地図データとしてtopojsonとgeojsonの２つがありどちらも使える状況にあったが，geojsonを用いる。理由としては
- topojsonの情報圧縮の仕方が難解
- 情報圧縮のため，地図の境界線がかくつく
- geojsonは重いが，地図読み込みは最初の一回だけなので特に問題がない
- geojsonは緯度経度をそのまま扱っているので，後の実装の時に便利

topojson形式を使う場合はtokyo.htmlのl25~l27をコメントアウト反転すればよい。

[github](https://gist.github.com/n1n9-jp/ed875e178c504aa7ae47) ：参考にしたgithubのサイト

[出典元](https://www.gsi.go.jp/kankyochiri/gm_jpn.html) ：出典元である国土地理院のページ
- 使用ライセンスは配布元に準じ、非営利目的の場合は「出典元(地球地図日本)の明記」を、営利目的の場合は「出典元(地球地図日本)の明記」と「著作権者(地球地図日本)への利用報告」が必要。今回は非営利目的なのでページの隅に「出典元：地球地図日本」とあればOK。



# レイアウト作成 
### 検索時に用いるチェックリストの作成
[参考にしたサイト](https://qiita.com/mojaie/items/268879cbe70f8bc5af50)

- 上記のサイトのコードをマイナーチェンジして検索時に用いるチェックリストの作成を行った。
(webpagediv.html)こちらではdivのviewport上で描画している。

- svg上でチェックリストを描画することも試みた。(webpage.html)
おそらくこちらは使わない。

- チェックボックスからスライダーに変更した。スライダーは逐次値の変化を追うのではなく、値が
完全に変更したらイベントが発生するようにした。

- 地図上に選択した項目の所在地を表示するか否かのon/offボタンを追加。[こちらのサイト](https://saruwakakun.com/html-css/reference/buttons#section4)のデザインを借りて装飾した。→
ボタンを4つ用意して、各ボタンに対応した色で構造物の所在地を表示できるようにした。→カラーピッカーの色に対応して色の変わる第５のボタンを追加した。

- チェックリスト全体のデザインを[こちらのサイト](https://www.yuu-diaryblog.com/2017/03/14/list-design/)
を参考に変更。各箱の幅が一定であり、親と子で箱の左側がずれているので箱の終わり(右側)が揃わずカッコ悪い。
→ parentがrootの場合はul.parentクラスを、それ以外はul.childrenクラスを付与することで解決。

- 地図上の密度表示の色を指定できるカラーピッカーを追加。

# 密度の計算方法案
- 施設一つ一つに対してその座標を中心とし，中心から離れるほど色が薄くなる大きな円を描き，色の濃さが重なるようにする(できる？)
    - 正確。全ピクセルに関して勝手に計算が行われる
    - 東京都の地図からは余裕ではみ出るので，適切な処理が必要
    - 出来るならこれがいいかもしれない。色を重ねるところが難点(透明度みたいなところを調節？)
- 区ごとに存在密度を求める
    - ガバガバ
    - 区の中の違いが見れない(pre reveiwでも同様の指摘があった)
    - 何より今回のコンセプトに合ってない
    - 計算+実装は楽そうかと思いきや案外区の中にある外にあるの判定を座標から行うのは面倒
- より細かい正方形に区切って一つ一つ色塗りをする
    - (最小の正方形である)ピクセルごとに塗る方法はあるか？（パッと調べた感じなさそう）
    - rectで原始的にやる方法だと，分け方が細かすぎた時(全ピクセルに長方形を割り当てるなど)重くなりそう
    - rectの中にある施設の個数だと個数が足りない(事が予想される)ので，周りのrectの場所も考慮する必要がある
        - rectのサイズは？
        - どれくらい周りまで取ってくるか？
        - 効率的な計算方法は？尺取法的に計算するなどの工夫
        - そもそもJavaScriptで計算するのは大丈夫なのか→[意外と速いらしい](https://qiita.com/hanaata/items/c91788bcac2a40f1bb05)
        - 一回計算して配列に入れれば特に動きが重くなったりはしないだろう
    - 県境付近の処理
        - 長方形の取り方
        - 計算の仕方


# 使用する地図について
Leaflet.js + OSMタイルマップ + d3.jsで表示する方法がよさそう。
文献  
[Leaflet + OSM + d3](https://qiita.com/osoken/items/52779536c2da67c479c5)  
[Leaflet + OSM](https://qiita.com/TakeshiNickOsanai/items/783caa9f31bcf762da16)  
[leflet.tyleLayer()について1](https://lendl.sakura.ne.jp/journals/leaflet-tile-layer/)  
[leflet.tyleLayer()について1](https://docs.eegeo.com/eegeo.js/v0.1.500/docs/leaflet/L.TileLayer/)


# 実装上の問題点に関して
d3は図形の表示順はコードで書かれている順。背面や前面に移動したり設置するなどの属性は実装されていない。そのため，地図は最背面(枠線だけの地図の場合は違う)，密度を表す色をその前，座標を表す点を最前面となるように，この順に表示しないと座標の点が薄くなったりしてしまう。また，複数の施設を表示するときは，すべての施設に対して密度→座標と表示しないと同様の不具合が起きる。tokyo.htmlではデータをすべて連想配列に入れて対処したが，leafletを使う実装ではupdate関数の処理において，d(data)を使っているため，連想配列を用いた処理が難しくなっている。
→data自体を連想配列に入れればいいのか
→非同期処理のせいで難しい

# 第二回Pre Reviewの指摘内容
色の重ね方を考えないと，WTFvisualizationで扱われたダメな例みたいにゴチャッとなってしまう
- 三原色や補色に限定する
- MAX2色

# 重くなりすぎる問題点
20000個も円を表示しているのが恐らく原因
対処法
 - 表示している地図の範囲のみで表示
 - 選択した地図の範囲のみで表示
 - データ数or表示範囲を減らす
 - 密度表示の仕方を工夫する
    - 区間ごとにまとめる
